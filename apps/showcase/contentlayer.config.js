import { defineDocumentType, makeSource } from 'contentlayer2/source-files';
import GithubSlugger from 'github-slugger';
import { h } from 'hastscript';
import rehypeAutolinkHeadings from 'rehype-autolink-headings';
import rehypePrettyCode from 'rehype-pretty-code';
import rehypeSlug from 'rehype-slug';
import { codeImport } from 'remark-code-import';
import remarkGfm from 'remark-gfm';
import { replaceApiTable, replaceComponentViewer } from './utils/getComponentReplacements';
import { themes } from './utils/highlight-code';
import { rehypeAttachMeta, rehypeNpmCommandMeta, rehypeReAttachMeta } from './utils/rehype-source-transform';

export const Docs = defineDocumentType(() => ({
    name: 'Docs',
    filePathPattern: '**/**/*.mdx',
    contentType: 'mdx',
    fields: {
        title: { type: 'string', required: true },
        description: { type: 'string', required: false },
        component: { type: 'string', required: false },
        styles: { type: 'list', of: { type: 'string' }, required: false },
        tokens: { type: 'list', of: { type: 'string' }, required: false },
        pts: { type: 'list', of: { type: 'string' }, required: false },
        autoGenerated: { type: 'boolean', required: false },
        lastUpdated: { type: 'date', required: false }
    },
    computedFields: {
        slug: {
            type: 'string',
            resolve: (doc) => {
                return `/docs/${doc._raw.flattenedPath.includes('features') ? doc._raw.sourceFileDir : doc._raw.flattenedPath}`;
            }
        },
        componentSlug: {
            type: 'string',
            resolve: (doc) => {
                return `${doc._raw.flattenedPath.includes('features') ? doc._raw.sourceFileDir : doc._raw.flattenedPath}`;
            }
        },
        llm: {
            type: 'string',
            resolve: async (doc) => {
                let content = `# ${doc.title}\n\n${doc.description}\n\n`;

                content += doc.body.raw;

                content = replaceComponentViewer(content);
                content = replaceApiTable(content);

                return content;
            }
        },
        toc: {
            type: 'list',
            of: { type: 'object' },
            resolve: async (doc) => {
                const regXHeader = /\n(?<flag>#{1,6})\s+(?<content>.+)/g;
                const slugger = new GithubSlugger();
                const raw = doc.body.raw;

                const codeBlocks = [...raw.matchAll(/```[\s\S]*?```/g)].map((m) => [m.index, m.index + m[0].length]);
                const isInCode = (pos) => codeBlocks.some(([s, e]) => pos >= s && pos < e);

                return [...raw.matchAll(regXHeader)]
                    .filter((m) => !isInCode(m.index))
                    .map((m) => ({
                        level: m.groups.flag.length,
                        text: m.groups.content,
                        slug: m.groups.content ? slugger.slug(m.groups.content) : undefined
                    }));
            }
        }
    }
}));

export default makeSource({
    contentDirPath: './docs',
    documentTypes: [Docs],
    mdx: {
        remarkPlugins: [remarkGfm, codeImport],
        rehypePlugins: [
            rehypeSlug,
            rehypeAttachMeta,
            [
                rehypePrettyCode,
                {
                    theme: themes,
                    keepBackground: false
                }
            ],
            rehypeReAttachMeta,
            rehypeNpmCommandMeta,
            [
                rehypeAutolinkHeadings,
                {
                    behavior: 'append',
                    properties: {
                        className: 'heading-anchor-link'
                    },
                    content: () => h('span', { class: 'ml-4 opacity-0 group-hover:opacity-50 hover:opacity-100 transition-opacity duration-150' }, '#')
                }
            ]
        ]
    }
});
